name: timesheet-app
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-app}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-app}
      POSTGRES_DB: ${POSTGRES_DB:-app_development}
      TZ: ${TZ:-Asia/Tokyo}
    volumes:
      - db-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 10

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
      args:
        RUBY_VERSION: "3.3.4"
        BUNDLER_VERSION: "2.5.15"
    env_file: .env
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-app}:${POSTGRES_PASSWORD:-app}@db:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-app_development}
      RAILS_ENV: ${RAILS_ENV:-development}
      RAILS_LOG_TO_STDOUT: ${RAILS_LOG_TO_STDOUT:-true}
      RAILS_MAX_THREADS: ${RAILS_MAX_THREADS:-5}
      FORCE_SSL: ${FORCE_SSL:-}
      TZ: ${TZ:-Asia/Tokyo}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:5173}
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - ./api:/app:cached
      - ./openapi:/openapi:cached
      - bundle-cache:/usr/local/bundle
    ports:
      - "3000:3000"
    command: ["/entrypoint-api.sh"] # 起動時分岐（dev: rails s / prod: puma）

  front:
    build:
      context: .
      dockerfile: front/Dockerfile
      args:
        NODE_VERSION: "20"
    env_file: .env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      VITE_API_ORIGIN: ${VITE_API_ORIGIN:-http://localhost:3000}
      TZ: ${TZ:-Asia/Tokyo}
    volumes:
      - ./front:/usr/src/app:cached
      - ./openapi:/openapi:cached
      - front-node-modules:/usr/src/app/node_modules
    ports:
      - "5173:5173"   # dev: Vite
      - "8080:8080"   # prod: nginx (ローカルで確認したい場合)
    command: ["/entrypoint-front.sh"] # 起動時分岐（dev: vite / prod: nginx）

volumes:
  db-data:
  bundle-cache:
  front-node-modules:
