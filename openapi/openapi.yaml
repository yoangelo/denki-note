openapi: 3.0.3
info:
  title: Timesheet API
  version: 0.1.0
servers:
  - url: ${VITE_API_ORIGIN}
paths:
  /health:
    get:
      operationId: health_check
      tags: [Health]
      summary: Health check
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /auth/login:
    post:
      operationId: login
      tags: [Authentication]
      summary: User login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user]
              properties:
                user:
                  type: object
                  required: [email, password]
                  properties:
                    email: { type: string, format: email }
                    password: { type: string }
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
        '401':
          description: Invalid credentials

  /auth/logout:
    delete:
      operationId: logout
      tags: [Authentication]
      summary: User logout
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
        '401':
          description: No active session
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }

  /auth/signup:
    post:
      operationId: signup
      tags: [Authentication]
      summary: User registration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [user]
              properties:
                user:
                  type: object
                  required: [email, password, display_name, tenant_id]
                  properties:
                    email: { type: string, format: email }
                    password: { type: string, minLength: 6 }
                    password_confirmation: { type: string }
                    display_name: { type: string }
                    tenant_id: { type: string, format: uuid }
      responses:
        '201':
          description: Registration successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
        '422':
          description: Validation errors

  /customers:
    get:
      operationId: list_customers
      tags: [Customers]
      summary: Incremental search customers
      parameters:
        - in: query
          name: query
          schema: { type: string }
        - in: query
          name: limit
          schema: { type: integer, default: 20, minimum: 1, maximum: 50 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Customer' }

  /customers/recent:
    get:
      operationId: get_recent_customers
      tags: [Customers]
      summary: Get recently used customers with sites
      parameters:
        - in: query
          name: limit
          schema: { type: integer, default: 3, minimum: 1, maximum: 10 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/RecentCustomer' }

  /sites:
    get:
      operationId: list_sites
      tags: [Sites]
      summary: Search sites by customer
      parameters:
        - in: query
          name: customer_id
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: query
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Site' }

    post:
      operationId: create_site
      tags: [Sites]
      summary: Create new site under a customer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              required: [site]
              type: object
              properties:
                site:
                  type: object
                  required: [customer_id, name]
                  properties:
                    customer_id: { type: string, format: uuid }
                    name: { type: string, maxLength: 200 }
                    note: { type: string, maxLength: 500 }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Site' }

  /daily_reports:
    get:
      operationId: list_daily_reports
      tags: [DailyReports]
      summary: Get daily reports list with work entries
      parameters:
        - in: query
          name: year_month
          schema: { type: string, pattern: '^[0-9]{4}-[0-9]{2}$' }
          description: Filter by year-month (YYYY-MM format)
        - in: query
          name: user_id
          schema: { type: string, format: uuid }
          description: Filter by user ID
        - in: query
          name: customer_id
          schema: { type: string, format: uuid }
          description: Filter by customer ID
        - in: query
          name: site_id
          schema: { type: string, format: uuid }
          description: Filter by site ID
        - in: query
          name: limit
          schema: { type: integer, default: 100, minimum: 1, maximum: 500 }
          description: Limit number of results
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                required: [daily_reports, meta]
                properties:
                  daily_reports:
                    type: array
                    items:
                      type: object
                      required: [id, work_date, customer, site, summary, work_entries, total_minutes, created_at, updated_at]
                      properties:
                        id: { type: string, format: uuid }
                        work_date: { type: string, format: date }
                        customer:
                          type: object
                          required: [id, name]
                          properties:
                            id: { type: string, format: uuid }
                            name: { type: string }
                        site:
                          type: object
                          required: [id, name]
                          properties:
                            id: { type: string, format: uuid }
                            name: { type: string }
                        summary: { type: string }
                        work_entries:
                          type: array
                          items:
                            type: object
                            required: [id, user, minutes]
                            properties:
                              id: { type: string, format: uuid }
                              user:
                                type: object
                                required: [id, display_name]
                                properties:
                                  id: { type: string, format: uuid }
                                  display_name: { type: string }
                              minutes: { type: integer }
                        total_minutes: { type: integer }
                        created_at: { type: string, format: date-time }
                        updated_at: { type: string, format: date-time }
                  meta:
                    type: object
                    required: [total_count, returned_count, year_month]
                    properties:
                      total_count: { type: integer }
                      returned_count: { type: integer }
                      year_month: { type: string }

  /daily_reports/bulk:
    post:
      operationId: bulk_create_daily_reports
      tags: [DailyReports]
      summary: Bulk create daily reports with work entries
      requestBody:
        required: true
        content:
          application/json:
            schema:
              required: [daily_reports]
              type: object
              properties:
                daily_reports:
                  type: array
                  minItems: 1
                  items:
                    required: [site_id, work_date, summary, work_entries]
                    type: object
                    properties:
                      site_id: { type: string, format: uuid }
                      work_date: { type: string, format: date }
                      summary: { type: string }
                      work_entries:
                        type: array
                        minItems: 1
                        items:
                          required: [user_id, minutes]
                          type: object
                          properties:
                            user_id: { type: string, format: uuid }
                            minutes:
                              type: integer
                              multipleOf: 15
                              minimum: 0
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: object
                required: [success, summary, reports, errors]
                properties:
                  success: { type: boolean }
                  summary:
                    type: object
                    required: [reports_created, entries_created]
                    properties:
                      reports_created: { type: integer }
                      entries_created: { type: integer }
                  reports:
                    type: array
                    items: { type: object }
                  errors:
                    type: array
                    items: { type: object }
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                type: object
                properties:
                  success: { type: boolean }
                  summary:
                    type: object
                    properties:
                      reports_created: { type: integer }
                      entries_created: { type: integer }
                  reports:
                    type: array
                    items: { type: object }
                  errors:
                    type: array
                    items:
                      type: object
                      properties:
                        report_index: { type: integer }
                        site_id: { type: string, format: uuid }
                        error: { type: string }

  /users:
    get:
      operationId: list_users
      tags: [Users]
      summary: Get users list
      parameters:
        - in: query
          name: is_active
          schema: { type: boolean }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/User' }

  /summaries/customer-month:
    get:
      operationId: get_customer_month_summary
      tags: [Summaries]
      summary: Get monthly hours & amount by customer
      parameters:
        - in: query
          name: customer_id
          required: true
          schema: { type: string, format: uuid }
        - in: query
          name: yyyymm
          required: true
          schema: { type: string, pattern: '^[0-9]{4}-[0-9]{2}$' }
        - in: query
          name: rate_toggle
          schema: { type: string, enum: ["on", "off"] }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                required: [rows, total_hours, amount_jpy]
                type: object
                properties:
                  rows:
                    type: array
                    items:
                      type: object
                      properties:
                        date: { type: string, format: date }
                        summary: { type: string }
                        hours: { type: number }
                  total_hours: { type: number }
                  amount_jpy: { type: integer }

components:
  schemas:
    HealthResponse:
      type: object
      required: [status, time, message]
      properties:
        status:
          type: string
          enum: [ok]
        time:
          type: string
          format: date-time
        message:
          type: string
          
    Customer:
      type: object
      required: [id, name]
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        customer_type: { type: string, enum: [individual, corporation], nullable: true }
        corporation_number: { type: string, nullable: true }
        rate_percent: { type: integer, nullable: true }
        unit_rate: { type: number, nullable: true }
        
    Site:
      type: object
      required: [id, name, customer_id]
      properties:
        id: { type: string, format: uuid }
        customer_id: { type: string, format: uuid }
        name: { type: string }
        note: { type: string, nullable: true }

    User:
      type: object
      required: [id, display_name, is_active]
      properties:
        id: { type: string, format: uuid }
        email: { type: string, format: email }
        display_name: { type: string }
        is_active: { type: boolean }
        tenant_id: { type: string, format: uuid }
        roles:
          type: array
          items: { type: string }
        is_admin: { type: boolean }
        is_member: { type: boolean }
        created_at: { type: string, format: date-time }

    RecentCustomer:
      type: object
      required: [id, name, site, last_used_at]
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        customer_type: { type: string, enum: [individual, corporation], nullable: true }
        corporation_number: { type: string, nullable: true }
        rate_percent: { type: integer, nullable: true }
        unit_rate: { type: number, nullable: true }
        site:
          type: object
          required: [id, name]
          properties:
            id: { type: string, format: uuid }
            name: { type: string }
        last_used_at: { type: string, format: date-time }